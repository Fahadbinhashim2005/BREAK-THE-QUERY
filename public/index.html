<!DOCTYPE html>
<html>
<head>
  <title>Break the Query | Nakshatra 26</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- TRANSPARENT OVERLAY HEADER -->
<div class="header">
  <img src="./nklogo.png" alt="Nakshatra Logo">
  <img src="./SAINTGITS LOGO .png" alt="Saintgits Logo">
</div>

<div class="hero" id="mainView">
  <div class="container" id="gameContainer">

    <h1>BREAK THE QUERY</h1>
    <p class="subtitle">NAKSHATRA 26 Â· WILD WEST SQL SHOWDOWN</p>

    <!-- ROUND BADGE -->
    <div id="roundBadge" class="timer">
      Waiting for roundâ€¦
    </div>

    <!-- TIMER -->
    <div id="timer" class="timer">
      Waiting for the Sheriffâ€™s signalâ€¦
    </div>

    <!-- QUESTION -->
    <div id="questionCard" class="card">
      <div class="card-title">ğŸ“œ Wanted Task</div>
      <p>Stand by, outlawâ€¦</p>
    </div>

    <!-- SCHEMA -->
    <div id="schemaCard" class="card">
      <div class="card-title">ğŸ—‚ Town Records</div>
      <pre>â€”</pre>
    </div>

    <!-- ANSWER INPUT -->
    <div class="card">
      <div class="card-title">âœï¸ Submit Your Query</div>

      <label>Outlaw No</label>
      <input id="roll" placeholder="Enter your outlaw number">

      <label id="answerLabel">SQL Query</label>
      <textarea id="answer" placeholder="Write your SQL query hereâ€¦"></textarea>

      <button id="submitBtn" onclick="submitAnswer()" disabled>
        ğŸ’° Claim Your Bounty ğŸ’°
      </button>
    </div>

  </div>
</div>

<script>
let leaderboardInterval = null;
let currentLeaderboardRound = null;

/* ================= LEADERBOARD RENDER ================= */

function renderLeaderboard(list, round) {
  const rows = list.map((s, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>${s.teamName}</td>
      <td>${s.leader}</td>
      <td>${s.college}</td>
      <td>${s.marks}</td>
      <td>${s.timeTaken}s</td>
    </tr>
  `).join("");

  document.getElementById("mainView").innerHTML = `
    <div class="container leaderboard">
      <h1>ğŸ† ${round.toUpperCase()} LEADERBOARD</h1>
      <p class="subtitle">Marks first Â· Faster Outlaws win ties</p>

      <table>
        <tr>
          <th>Rank</th>
          <th>Gang Name</th>
          <th>Leader</th>
          <th>College</th>
          <th>Marks</th>
          <th>Time</th>
        </tr>
        ${rows}
      </table>
    </div>
  `;
}

/* ================= MAIN POLLING ================= */

function startLeaderboard(round) {
  if (leaderboardInterval) clearInterval(leaderboardInterval);

  fetch(`/leaderboard/${round}`)
    .then(res => res.json())
    .then(list => renderLeaderboard(list, round));

  leaderboardInterval = setInterval(() => {
    fetch(`/leaderboard/${round}`)
      .then(res => res.json())
      .then(list => renderLeaderboard(list, round));
  }, 2000);
}

function stopLeaderboard() {
  if (leaderboardInterval) {
    clearInterval(leaderboardInterval);
    leaderboardInterval = null;
    currentLeaderboardRound = null;
  }
}

function loadQuestion() {
  fetch("/question")
    .then(res => res.json())
    .then(data => {

      /* ğŸ”¥ LEADERBOARD MODE */
      if (data.leaderboard && data.round) {
        if (currentLeaderboardRound !== data.round) {
          currentLeaderboardRound = data.round;
          startLeaderboard(data.round);
        }
        return;
      }

      /* ğŸ” Back to question mode */
      stopLeaderboard();

      if (!data.active) return;

      const badge = document.getElementById("roundBadge");
      const answerLabel = document.getElementById("answerLabel");
      const answerBox = document.getElementById("answer");

      badge.classList.remove("round1", "round2");
      badge.classList.add(data.round);

      if (data.round === "round1") {
        badge.innerText = "ğŸ¯ ROUND 1 â€“ WRITE THE QUERY";
        answerLabel.innerText = "SQL Query";
        answerBox.placeholder = "Write your SQL query hereâ€¦";
      } else {
        badge.innerText = "âš ï¸ ROUND 2 â€“ BREAK THE QUERY";
        answerLabel.innerText = "Corrected SQL Query";
        answerBox.placeholder = "Correct the errors in the given SQL queryâ€¦";
      }

      document.getElementById("questionCard").innerHTML = `
        <div class="card-title">ğŸ“œ Wanted Task</div>
        <p>${data.text}</p>
      `;

      document.getElementById("schemaCard").innerHTML = `
        <div class="card-title">ğŸ—‚ Town Records</div>
        <pre>${data.schema}</pre>
      `;

      const min = Math.floor(data.remaining / 60);
      const sec = data.remaining % 60;

      const timer = document.getElementById("timer");
      timer.innerText = `â± Time Left: ${min}:${sec.toString().padStart(2, "0")}`;

      document.getElementById("submitBtn").disabled = data.remaining === 0;
    });
}

setInterval(loadQuestion, 1000);

/* ================= SUBMISSION ================= */

function submitAnswer() {
  const roll = document.getElementById("roll").value.trim();
  const answer = document.getElementById("answer").value.trim();

  if (!roll || !answer) {
    alert("Fill all fields, outlaw.");
    return;
  }

  fetch("/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ roll, answer })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert("âŒ " + data.error);
      return;
    }

    document.getElementById("mainView").innerHTML = `
      <div class="container">
        <h1>BOUNTY SUBMITTED</h1>
        <p class="subtitle">Outlaw submission recorded successfully.</p>
      </div>
    `;
  });
}
</script>

</body>
</html>